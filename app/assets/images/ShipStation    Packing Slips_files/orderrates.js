SS.settings.ServiceMapping=Ext.extend(Ext.window.Window,{initComponent:function(){Ext.apply(this,{height:320,width:!_settings.CanShip||!_settings.CanFulfill?400:600,modal:true,title:"Create a Service Mapping",layout:{type:"vbox",align:"stretch"},items:[{tpl:'You can map the shipping service code <b style="color:green">{serviceCode}</b> to a ShipStation shipping service so that any order that specifies this shipping code will automatically be configured to use that service.<br><br>This mapping will apply strictly to your <b>{storeName}</b> store.',data:{serviceCode:this.serviceCode,storeId:this.storeId,storeName:this.storeName},bodyPadding:8,border:false},{xtype:"form",url:SS.url.app+"settings/addstoremapping",border:false,bodyPadding:4,flex:1,defaults:{border:false},layout:{type:"vbox",align:"stretch"},items:[{layout:{type:"hbox",align:"stretch"},flex:1,items:[{margins:"0 4 4 8",border:true,flex:1,bodyPadding:8,title:"Shipment Service",hidden:!_settings.CanShip,layout:"anchor",defaults:{anchor:"100%"},items:[{xtype:"providerservicepackage",itemId:"psp",carrierField:"providerID",serviceField:"serviceID",packageField:"packageTypeID",defaults:{labelWidth:100,labelAlign:"right"}}]},{title:"Fulfillment Service",border:true,flex:1,hidden:!_settings.CanFulfill,margins:"0 4 4 4",itemId:"fillinfo",layout:"anchor",bodyPadding:8,defaults:{labelWidth:90,anchor:"100%"},items:[{xtype:"fillprovider_combo",fieldLabel:"Provider",name:"fillProviderId",listeners:{scope:this,change:function(a,b){a.next().setDisabled(!b)}}},{xtype:"fillservice_combo",fieldLabel:"Service",disabled:true,itemId:"cboFillService",name:"fillServiceId"}]}]},{margin:"6 0 8 8",labelWidth:300,labelAlign:"right",itemId:"fill-method",xtype:"radiogroup",hidden:!_settings.CanShip||!_settings.CanFulfill,fieldLabel:"<b>Preferred (Default) Method</b>",items:[{boxLabel:"Ship the Order",name:"fillMethod",inputValue:"1",checked:_settings.CanShip},{boxLabel:"Request a fulfillment",name:"fillMethod",inputValue:"2",checked:_settings.CanFulfill&&!_settings.CanShip}]}]}],buttons:[{text:"Cancel",scope:this,handler:function(){this.close()}},"->",{text:"<b>Save Mapping</b>",scope:this,handler:function(){this.setLoading("Please Wait...");var a=this.down("form").getForm().getValues();Ext.apply(a,{storeId:this.storeId,serviceCode:this.serviceCode});Ext.Ajax.request({url:SS.url.app+"settings/addstoremapping",params:a,method:"POST",scope:this,success:function(a){this.setLoading(false);var b=Ext.decode(a.responseText);if(b.success){this.fireEvent("applied");this.close()}},failure:function(){this.setLoading(false)}})}}]});this.callParent();this.on("afterrender",function(){this.setLoading("Please wait...");Ext.Ajax.request({url:SS.url.app+"settings/getstoremapping",params:{storeId:this.storeId,serviceCode:this.serviceCode},method:"POST",scope:this,success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);if(a.success){this.down("form").getForm().setValues(a);this.down("#cboCarrier").setValue(a.providerId);this.down("#cboService").setValue(a.serviceId);this.down("#cboPackage").setValue(a.packageTypeId)}},failure:function(){this.setLoading(false)}})},this)}});SS.BatchShip=Ext.extend(Ext.panel.Panel,{applyPreset:function(b){var f=SS.data.OrderStores.PresetStore.findExact("PresetID",b);if(f>-1){this.setLoading("Please wait...");for(var d=this.down("#batchForm"),e=d.getForm(),g=e.getValues(),c=[],a=0;a<this.records.length;a++)c.push(this.records[a].get("OrderID"));this.doMassUpdate({PresetID:b,orderIds:c.join(",")})}},updateSummary:function(b){var a={Count:b.length,Total:0,Errors:0};Ext.Array.each(b,function(b){if(b.data.RateError)a.Errors++;else a.Total+=b.data.ShippingCost+b.data.ConfirmationCost+b.data.InsuranceCost+b.data.OtherCost});this.down("#selectedSummary").setTitle(a.Count+" orders selected...");this.down("#selectedSummary").update(a);this.down("#header").update(a)},loadRecords:function(b){this.records=b;this.down("#batchForm").getForm().reset();this.down("#bulkfields").items.each(function(a){a.hide()});this.down("#batchForm").down("#fldselect").show();var a=SS.data.OrderStores.PresetStore.getCount();this.down("#radfield").setVisible(a>0);this.down("#radpreset").setVisible(a>0);this.down("#fldpreset").setVisible(a>0);this.updateSummary(b)},doMassUpdate:function(a){this.setLoading("Please wait...");Ext.Ajax.request({scope:this,url:SS.url.app+"orders/MassUpdate",method:"POST",params:a,success:function(h,d){var e=Ext.decode(h.responseText);if(e.success){var b={};if(d.params.PresetID){var i=SS.data.OrderStores.PresetStore.findExact("PresetID",d.params.PresetID),a=SS.data.OrderStores.PresetStore.getAt(i);a.data.WarehouseID!=null&&Ext.apply(b,{WarehouseID:a.data.WarehouseID});a.data.ProviderID!=null&&Ext.apply(b,{ProviderID:a.data.ProviderID});a.data.ServiceID!=null&&Ext.apply(b,{ServiceID:a.data.ServiceID});a.data.PackageTypeID!=null&&Ext.apply(b,{RequestedPackageTypeID:a.data.PackageTypeID});a.data.InsuranceProviderID!=null&&Ext.apply(b,{InsuranceProvider:a.data.InsuranceProviderID});a.data.ConfirmationID!=null&&Ext.apply(b,{Confirmation:a.data.ConfirmationID});a.data.Height!=null&&Ext.apply(b,{Height:a.data.Height});a.data.Width!=null&&Ext.apply(b,{Width:a.data.Width});a.data.Length!=null&&Ext.apply(b,{Length:a.data.Length});if(a.data.WeightOz!=null){var f,g;f=a.data.WeightOz/16;g=a.data.WeightOz%16;Ext.apply(b,{WeightLbs:Math.floor(f),WeightOz:g})}}else Ext.Object.each(d.params,function(a,c){if(a=="orderIds")return;b[a]=c},this);for(var c=0;c<this.records.length;c++){this.records[c].beginEdit();this.records[c].set(b);this.records[c].set("ShippingCost",null);this.records[c].set("OtherCost",null);this.records[c].set("InsuranceCost",null);this.records[c].set("ConfirmationCost",null);this.records[c].set("RateError",null);this.records[c].endEdit();this.records[c].commit()}this.updateSummary(this.records);this.fireEvent("batchupdate",this.records)}else Ext.Msg.alert("An error occurred!",e.message);this.setLoading(false)}});if(a.PresetID)_kmq.push(["record","[Orders] Applied Preset (Bulk)"]);else _kmq.push(["record","[Orders] Bulk Update"])},initComponent:function(){Ext.apply(this,{defaults:{border:false,margin:"8"},items:[{baseCls:"x-plain",itemId:"header",tpl:'<h2 class="title">{Count} Orders Selected</h2>'},{preventHeader:true,baseCls:"x-plain",itemId:"selectedSummary",bodyStyle:"text-align:center",bodyPadding:8,frame:true,html:"",tpl:['<span style="font-size:1.5em; font-weight:bold;">Total Rate: <span style="color:green;">{[Ext.util.Format.currency(values.Total, "$", 2)]}</span></span><br>','<tpl if="Errors"><div style="padding-top:6px"><img  src=\''+SS.url.app+'icons/warn16.png\' height="16" width="16" align=\'top\'> <span style="color:orange; font-size:1.2em; font-weight:bold;">{Errors} error(s)</span></div></tpl>']},{layout:{type:"hbox",align:"stretchmax"},height:42,border:false,items:[{xtype:"button",scale:"medium",flex:.5,margin:"0 2 0 0",itemId:"btnGetRates",text:"<b>Get Rates</b>",icon:SS.url.app+"icons/rates.png",scope:this,handler:function(){this.setLoading("Please wait...");SS.helper.UpdateOrderRates(this.records,function(b,a){this.setLoading(false);b&&this.updateSummary(a)},this)}},{xtype:"button",scale:"medium",margin:"0 0 0 2",flex:.5,itemId:"btnShip",text:"<b>Ship Orders</b>",icon:SS.url.app+"icons/ship.png",scope:this,handler:function(){var a=new SS.ship.ShipOrders({orders:this.records});a.on("ordersshipped",function(c){for(var a=Ext.StoreMgr.get("loadingdockstore"),b=0;b<c.length;b++){var d=a.findExact("OrderID",c[b].get("OrderID"));d>-1&&a.removeAt(d)}a.sync()},this);a.show()}}]},{baseCls:"x-plain",html:'<h2 class="title">Bulk Update Selected Orders</h2><div style="margin:6px 0 0 0">Set values for all of the selected orders by selecting a field and specifying a value</div>'},{xtype:"form",itemId:"batchForm",title:"Bulk update selected orders...",frame:false,baseCls:"x-plain",preventHeader:true,autoScroll:true,autoHeight:true,bodyStyle:"background-color:transparent",fieldDefaults:{labelWidth:80,labelAlign:"left",anchor:"96%"},buttonAlign:"center",buttons:[{xtype:"button",scale:"medium",itemId:"btnApplyToAll",text:"<b>Apply to Selected Orders</b>",icon:SS.url.app+"icons/check24.png",scope:this,handler:function(){for(var e=this.down("#batchForm"),f=e.getForm(),a=f.getValues(),d=[],c=0;c<this.records.length;c++)d.push(this.records[c].get("OrderID"));var b={orderIds:d.join(",")};if(a.bulkmode=="preset")b.PresetID=a.PresetID;else if(a.fldselect=="fldinsurance"){b.InsuranceProvider=a.InsuranceProvider;if(a.InsuredValue)b.InsuredValue=a.InsuredValue}else if(a.fldselect=="fldCSP"){b.ProviderID=a.ProviderID;b.ServiceID=a.ServiceID;if(a.RequestedPackageTypeID)b.RequestedPackageTypeID=a.RequestedPackageTypeID}else if(a.fldselect=="fldwarehouse")b.WarehouseID=a.WarehouseID;else if(a.fldselect=="fldconfirmation")b.Confirmation=a.Confirmation;else if(a.fldselect=="fldsize"){b.Width=a.Width;b.Length=a.Length;b.Height=a.Height}else if(a.fldselect=="fldweight"){b.WeightLbs=a.WeightLbs;b.WeightOz=a.WeightOz}else return;this.doMassUpdate(b)}}],items:[{xtype:"panel",margins:"0 0 8 0",itemId:"lblMulti",hidden:true,bodyStyle:"background-color:#eeffee; padding:4px; border:solid 1px green;",html:"<b>Multiple orders are currently selected.</b>  To apply shipping settings to all selected orders, make selections below and click <b>'Apply to Selected Orders'</b>.<br>"},{xtype:"radio",hideLabel:true,itemId:"radfield",boxLabel:"<b>Set a specific field...</b>",name:"bulkmode",inputValue:"field",checked:true,scope:this,handler:function(a){this.down("#bulkfields").setDisabled(!a.checked);this.down("#fldselect").setDisabled(!a.checked)}},{xtype:"combo",fieldLabel:"Set value",labelAlign:"right",store:new Ext.data.ArrayStore({id:0,fields:["fieldId","Name"],data:[["fldwarehouse","Warehouse"],["fldCSP","Carrier/Service/Package"],["fldconfirmation","Confirmation"],["fldinsurance","Insurance"],["fldweight","Weight"],["fldsize","Dimensions"]]}),valueField:"fieldId",displayField:"Name",queryMode:"local",listWidth:200,value:1,itemId:"fldselect",name:"fldselect",autoSelect:false,forceSelection:true,triggerAction:"all",lazyInit:false,editable:false,typeAhead:false,emptyText:"Select...",listeners:{scope:this,select:function(a,b){this.down("#bulkfields").items.each(function(a){a.hide()});a.up("form").down("#fldselect").show();a.up("form").down("#"+b[0].data.fieldId).show()}}},{xtype:"fieldcontainer",itemId:"bulkfields",layout:"anchor",fieldDefaults:{labelWidth:80,labelAlign:"right"},defaults:{anchor:"100%"},anchor:"100%",items:[new SS.fields.WarehouseCombo({itemId:"fldwarehouse",hidden:true,labelAlign:"right",fieldLabel:"Warehouse",name:"WarehouseID"}),{xtype:"providerservicepackage",itemId:"fldCSP",hidden:true,carrierField:"ProviderID",serviceField:"ServiceID",packageField:"RequestedPackageTypeID",defaults:{labelWidth:80,labelAlign:"right"}},{xtype:"fieldcontainer",id:"fldconfirmation",hidden:true,labelAlign:"right",fieldLabel:"Confirmation",layout:{type:"hbox",align:"top"},anchor:"100%",defaults:{},items:[{xtype:"combo",labelWidth:80,flex:1,name:"Confirmation",store:new Ext.data.ArrayStore({id:0,fields:["ConfirmationID","Name"],data:[[0,"Service Default"],[1,"Delivery"],[2,"Signature"],[3,"Adult Signature"]]}),valueField:"ConfirmationID",displayField:"Name",queryMode:"local",listWidth:200,value:0,autoSelect:false,forceSelection:true,triggerAction:"all",lazyInit:false,editable:false,typeAhead:false,emptyText:"Select..."},{xtype:"box",width:24,padding:"3 0 3 5",html:'<img src="'+SS.url.app+'icons/help16.png" data-hide="user" data-qtitle=\'&quot;Service Default Confirmation&quot;\' data-qwidth="200" data-qtip="Selecting &quot;Service Default&quot; will select the best confirmation method that doesn\'t require an additional fee based on the selected shipping service for the order.">'}]},{xtype:"fieldcontainer",id:"fldinsurance",hidden:true,anchor:"100%",defaults:{anchor:"100%"},items:[{xtype:"combo",labelWidth:80,labelAlign:"right",fieldLabel:"Insurance",name:"InsuranceProvider",store:new Ext.data.ArrayStore({id:0,fields:["InsuranceId","Name"],data:[[0,"None"],[1,"Shipsurance Discount Insurance"],[2,"Carrier Insurance"],[3,"Other (External)"]]}),valueField:"InsuranceId",displayField:"Name",value:1,queryMode:"local",listWidth:200,autoSelect:false,forceSelection:false,triggerAction:"all",lazyInit:false,editable:false,typeAhead:false,emptyText:"Select..."},{fieldLabel:"Insured Value",labelWidth:80,name:"InsuredValue",labelAlign:"right",xtype:"numberfield",allowDecimals:false,allowNegative:false,anchor:null,fieldWidth:50}]},{fieldLabel:"Dimensions",itemId:"fldsize",hidden:true,xtype:"fieldcontainer",labelAlign:"right",layout:{type:"hbox",pack:"start",align:"top"},items:[{xtype:"numberfield",name:"Width",width:48,minValue:0,allowNegative:false,allowDecimals:true,maxLength:5,step:.25,repeatTriggerClick:false},{html:"&nbsp;x&nbsp;",border:false,xtype:"box",style:"padding-top:8px; padding-right:0px;"},{xtype:"numberfield",width:48,name:"Length",minValue:0,allowNegative:false,allowDecimals:true,maxLength:5,step:.25,repeatTriggerClick:false},{html:"&nbsp;x&nbsp;",border:false,xtype:"box",style:"padding-top:8px; padding-right:0px;"},{xtype:"numberfield",width:48,name:"Height",minValue:0,allowNegative:false,allowDecimals:true,maxLength:5,step:.25,repeatTriggerClick:false},{html:"&nbsp;",xtype:"box",border:false,style:"padding-top:8px; padding-right:0px;"}]},{fieldLabel:"Weight",itemId:"fldweight",xtype:"fieldcontainer",labelAlign:"right",hidden:true,layout:"hbox",items:[{width:50,allowNegative:false,allowDecimals:false,maxLength:3,name:"WeightLbs",minValue:0,xtype:"numberfield",repeatTriggerClick:false},{html:"&nbsp;lbs.&nbsp;&nbsp;",border:false,xtype:"box",style:"padding-top:8px; padding-right:0px;"},{xtype:"numberfield",width:50,name:"WeightOz",minValue:0,allowNegative:false,allowDecimals:false,repeatTriggerClick:false},{html:"&nbsp;oz.",border:false,xtype:"box",style:"padding-top:8px; padding-right:0px;"}]}]},{xtype:"radio",hideLabel:true,margin:"16 0 6 0",itemId:"radpreset",boxLabel:"<b>Apply a Shipping Preset...</b>",name:"bulkmode",inputValue:"preset",scope:this,handler:function(a){this.down("#fldpreset").setDisabled(!a.checked)}},{xtype:"combo",fieldLabel:"Apply Preset",labelAlign:"right",disabled:true,store:SS.data.OrderStores.PresetStore,valueField:"PresetID",displayField:"Name",queryMode:"local",listWidth:200,value:1,itemId:"fldpreset",name:"PresetID",autoSelect:false,forceSelection:true,triggerAction:"all",lazyInit:false,editable:false,typeAhead:false,emptyText:"Select...",listeners:{select:function(){}}}]},{baseCls:"x-plain",margin:"16 8",html:'<h2 class="title">Address Verification</h2><div style="margin:6px 0 0 0">To reverify the addresses for the selected orders, click the "Reverify Addresses" button below.</div>',buttonAlign:"center",buttons:[{xtype:"button",scale:"medium",itemId:"btnRevalidateAll",text:"<b>Reverify Addresses</b>",icon:SS.url.app+"icons/check24.png",scope:this,handler:function(){for(var b=[],a=0;a<this.records.length;a++)b.push(this.records[a].get("OrderID"));Ext.Ajax.request({url:SS.url.app+"orders/BulkValidateAddress",params:{orderIds:b},method:"POST",success:function(){amplify&&amplify.publish("ordergrid_startBulkUpdate","Reverifying Addresses")}});_kmq.push(["record","[Orders] Address Verified (Bulk)"])}}]}]});var a=this;this.callParent();amplify.subscribe("rates_updated",this,function(){this.records&&this.updateSummary(this.records)},5)}});SS.orders.Ship=Ext.extend(Ext.panel.Panel,{applyChanges:function(){this.down("#rateForm").getForm().updateRecord(this.record)},isCalculator:false,autoApplyChanges:true,getValues:function(){var a=this.down("#rateForm");return a.getValues()},showMultiPackage:function(){var b=this.record.data.ProviderID==3||this.record.data.ProviderID==4||this.record.data.ProviderID==13;this.down("#lnkpackages").setVisible(b);if(b){var a=this.record.OrderPackages().getCount();if(a>0)this.down("#btnPackages").setText("<b>"+a+" PACKAGES TOTAL</b>");else this.down("#btnPackages").setText("Ship Multiple Packages");if(this.down("#insuredValue"))if(a<1&&this.record.data.InsuranceProvider)this.down("#insuredValue").setDisabled(false);else this.down("#insuredValue").setDisabled(true);if(this.down("#dimensions")&&this.down("#weight"))if(a<1){this.down("#dimensions").setDisabled(false);this.down("#weight").setDisabled(false)}else{this.down("#dimensions").setDisabled(true);this.down("#weight").setDisabled(true)}}},buildPresetMenu:function(){this.presetMenu.removeAll();for(var a=SS.data.OrderStores.PresetStore.getRange(),b=0;b<a.length;b++){var c=a[b].get("Name"),d=a[b].get("HotKey");if(d){var e='<span style="color:steelblue; ">(Ctrl+'+String.fromCharCode(d)+")</span>";c+=" "+e}this.presetMenu.add({text:c,presetid:a[b].get("PresetID"),icon:SS.url.app+"icons/lightning-16.png"})}a.length==0&&this.presetMenu.add({text:"<i>No presets have been created.</i>",style:" font-size:0.9em; padding:8px;",plain:true});this.presetMenu.add("-");this.presetMenu.add({text:"Manage Shipping Presets...",itemId:"manage-presets",itemId:"manage-presets",icon:SS.url.app+"icons/edit.gif"})},initComponent:function(){var b=null,a=null;b={xtype:"providerservicepackage",carrierField:"ProviderID",requireCarrier:this.isCalculator,itemId:"cpsCombos",serviceField:this.isCalculator?null:"ServiceID",packageField:"RequestedPackageTypeID",confirmationField:"Confirmation",anchor:"100%",defaults:{labelWidth:80}};a={xtype:"fillServicePackage",itemId:"cpsFillCombos",anchor:"94%",defaults:{anchor:"100%",labelWidth:80}};Ext.apply(this,{border:false,defaults:{border:false},layout:"fit",items:[{xtype:"form",padding:0,itemId:"rateForm",bodyStyle:"background-color:transparent",border:false,onFieldChange:function(){},autoScroll:true,fieldDefaults:{labelWidth:80,labelAlign:"left"},layout:"anchor",defaults:{anchor:"96%"},listeners:{scope:this,afterrender:function(a){var b=this;a.getForm().getFields().each(function(a){a.on("change",function(a){this.fireEvent("datachange",a);if(a.name=="InsuranceProvider"&&this.record){var b=this.record.OrderPackages().getCount();if(b<1&&this.record.data.InsuranceProvider)this.down("#insuredValue").setDisabled(false);else this.down("#insuredValue").setDisabled(true);this.down("#insuredValue").labelEl.update((this.record.data.ProviderID==3||this.record.data.ProviderID==4)&&this.record.data.InsuranceProvider==2?"Declared Value:":"Insured Value:")}if(a.name=="ProviderID"&&this.record){this.showMultiPackage();this.down("#upsTm").setVisible(this.record.data.ProviderID==3);this.down("#insuredValue").labelEl.update((this.record.data.ProviderID==3||this.record.data.ProviderID==4)&&this.record.data.InsuranceProvider==2?"Declared Value:":"Insured Value:")}a.itemId=="fill-method"&&this.shipOrFill()},this)},this)}},items:[{xtype:"sliderfield",itemId:"fill-method",name:"FillMethod",minValue:1,maxValue:2,hidden:!_settings.CanShip||!_settings.CanFulfill||this.isCalculator,increment:1,hideLabel:false,margin:"10 26 0 20"},{layout:{type:"hbox",align:"stretch",pack:"start"},defaults:{border:false},border:false,hidden:!_settings.CanShip||!_settings.CanFulfill||this.isCalculator,margin:"4 40 4 20",height:24,anchor:"100%",itemId:"fill-method-label",items:[{html:"Shipment",flex:1,bodyStyle:"cursor:hand; cursor:pointer;",listeners:{scope:this,afterrender:function(a){a.el.on("click",function(){this.down("#fill-method").setValue(1)},this)}}},{html:"Fulfillment",flex:1,bodyStyle:"cursor:hand; cursor:pointer;",listeners:{scope:this,afterrender:function(a){a.el.on("click",function(){this.down("#fill-method").setValue(2)},this)}}}]},{margin:"6 0 4 0",title:"Quoted Rate",height:42,preventHeader:true,itemId:"rateQuote",bodyStyle:"text-align:center",bodyPadding:2,tpl:['<tpl if="ShippingCost">','<tpl if="ProviderID == 1 || ProviderID == 5">','<div style="float: right; padding-right: 15px; padding-top: 3px"><img src="images/provider/sm/usps.png" /></div>',"</tpl>",'<tpl if="ProviderID == 3">','<div style="float: right; padding-right: 15px; padding-top: 3px"><img src="images/provider/sm/t_ups.png" /></div>',"</tpl>",'<tpl if="ProviderID == 4">','<div style="float: right; padding-right: 5px; padding-top: 5px"><img src="images/provider/sm/t_fedex.png" /></div>',"</tpl>",'<tpl if="ProviderID == 13">','<div style="float: right; padding-right: 5px; padding-top: 7px"><img src="images/provider/sm/dhl express.png" /></div>',"</tpl>",'<tpl if="ProviderID == 14">','<div style="float: right; padding-right: 5px; padding-top: 1px"><img src="images/provider/sm/t_ontrac.png" /></div>',"</tpl>",'<div style="font-size:1.6em; padding:7px; padding-top: 9px; font-weight:bold">Rate: <span style="color:green; font-style:italic">{[Ext.util.Format.currency(values.ShippingCost+values.ConfirmationCost+values.InsuranceCost+values.OtherCost, "$", 2)]}</span></div>',"</tpl>",'<tpl if="!ShippingCost">','<tpl if="RateError">',"<img src='"+SS.url.app+'icons/warn16.png\' height="16" width="16" align=\'absmiddle\' style="float:left"> <div style="text-align:left; margin-left:24px;">{RateError}</div>',"</tpl>",'<tpl if="!RateError">','<tpl if="(BillToParty == 1 || BillToParty == 2) && (ProviderID == 3 || ProviderID == 4 || ProviderID == 13 || ProviderID == 14)">',"<img src='"+SS.url.app+'icons/unverified.png\' height="16" width="16" align=\'absmiddle\' style="float:left"> <div style="text-align:left; margin-left:24px;">Unable to obtain rates for 3rd party billing</div>',"<tpl else>","<img src='"+SS.url.app+'icons/unverified.png\' height="16" width="16" align=\'absmiddle\' style="float:left"> <div style="text-align:left; margin-left:24px;">Click \'Get Rate\' to update the quote for this shipment</div>',"</tpl>","</tpl>","</tpl>"],frame:true,hidden:this.isCalculator||!this.autoApplyChanges},{layout:{type:"hbox",align:"stretchmax",pack:this.isCalculator?"start":"start"},height:42,hidden:this.isCalculator||!this.autoApplyChanges,border:false,items:[{xtype:"button",scale:"medium",flex:.35,margin:"0 2 0 0",itemId:"btnRate",text:"<b>Get Rate</b>",disabled:false,icon:SS.url.app+"icons/rates.png",scope:this,handler:function(){this.fireEvent("datachange");this.setLoading("Please Wait...");SS.helper.UpdateOrderRates([this.record],function(b,a){this.setLoading(false);if(b){this.down("#rateQuote").update(a[0].data);this.down("#upsTm").setVisible(this.record.data.ProviderID==3)}},this)}},{xtype:"button",scale:"medium",margin:"0",flex:.55,itemId:"btnCalc",text:"<b>Send to Calculator</b>",disabled:false,icon:SS.url.app+"icons/calculator.png",scope:this,handler:function(){var a=new SS.RateCalculator({record:this.record});a.on("recordupdated",function(a){this.fireEvent("batchupdate",[a]);this.down("#rateQuote").update(this.record.data);panels.east.down("#order-rates").loadRecords([this.record]);panels.east.down("#orderTabs").updateNextBack()},this);a.show()}}]},{itemId:"reqService",bodyStyle:"text-align:center",bodyPadding:"2 2 12 2",border:false,hidden:this.isCalculator,tpl:['<tpl if="RequestedShippingService">','<a style="right:0px; position:absolute;" href="javascript:;" onclick="SS.helper.Help.show([1002924])"><img src="'+SS.url.app+'icons/help16.png" align="absmiddle"></a>','<tpl if="(FillMethod == 1 && RequestedShippingServiceID) || (FillMethod == 2 && FillServiceID)">',"Buyer Requested a <b>Mapped Service:</b>","<br>",'<a href="javascript:;" style="color:green; font-weight:bold;" service="{RequestedShippingService}">{RequestedShippingService}</a>',"<tpl else>","Buyer Requested an <b>Unmapped Service:</b>","<br>",'<a href="javascript:;" style="color:red; font-weight:bold;" service="{RequestedShippingService}">{RequestedShippingService}</a> ',"</tpl>","<tpl else>","<i>Buyer did not specify a service...</i>","</tpl>"],listeners:{scope:this,afterrender:function(a){a.el.on("click",function(f,e){if(e.tagName=="A"){var b=this.record.get("RequestedShippingService"),d=this.record.get("StoreID"),c=this.record.get("StoreName"),a=new SS.settings.ServiceMapping({serviceCode:b,storeId:d,storeName:c});a.on("applied",function(){var a=panels.center.down("#order-grid");a.saveSelection();a.store.on("load",function(){this.restoreSelection()},a,{single:true});panels.center.down("#order-grid").store.load()},this);a.show()}},this)}}},{layout:"card",border:false,itemId:"ship-or-fill",items:[a,{itemId:"ship-settings",layout:"anchor",border:false,items:[{bodyStyle:"text-align:right",border:false,html:'<a href="javascript:;" class="preset-menu">Shipping Presets</a>',hidden:this.isCalculator,listeners:{scope:this,afterrender:function(a){a.el.on("click",function(b,a){a.tagName=="A"&&this.presetMenu.showBy(a,"tr-br")},this)}}},new SS.fields.WarehouseCombo({fieldLabel:"Warehouse",name:"WarehouseID",allowBlank:!this.isCalculator,validateOnBlur:false}),b,{xtype:"combo",fieldLabel:"Insurance",name:"InsuranceProvider",hidden:this.isCalculator,store:new Ext.data.ArrayStore({id:0,fields:["InsuranceId","Name"],data:[[0,"None"],[1,"Shipsurance Discount Insurance"],[2,"Carrier Insurance"],[3,"Other (External)"]]}),valueField:"InsuranceId",displayField:"Name",value:1,queryMode:"local",listWidth:200,autoSelect:false,forceSelection:false,triggerAction:"all",lazyInit:false,editable:false,typeAhead:false,emptyText:"Select..."},{fieldLabel:"Insured Value",xtype:"numberfield",disabled:true,hidden:this.isCalculator,name:"InsuredValue",itemId:"insuredValue",decimalPrecision:2,allowDecimals:true,allowNegative:false,anchor:null,hideTrigger:true,keyNavEnabled:false,mouseWheelEnabled:false,fieldWidth:50},{xtype:"fieldset",padding:0,height:140,border:false,anchor:"94%",items:[{fieldLabel:"Dimensions (in inches)",xtype:"fieldcontainer",labelAlign:"top",itemId:"dimensions",anchor:"100%",layout:{type:"hbox",pack:"start",align:"top"},items:[{xtype:"numberfield",width:54,minValue:0,allowDecimals:true,allowNegative:false,name:"Length",emptyText:"L",maxLength:5,step:.25,repeatTriggerClick:false},{html:"&nbsp;&nbsp;x&nbsp;&nbsp;",border:false,xtype:"box",style:"padding-top:8px; padding-right:0px;"},{xtype:"numberfield",width:54,minValue:0,allowDecimals:true,allowNegative:false,name:"Width",emptyText:"W",maxLength:5,step:.25,repeatTriggerClick:false},{html:"&nbsp;&nbsp;x&nbsp;&nbsp;",border:false,xtype:"box",style:"padding-top:8px; padding-right:0px;"},{xtype:"numberfield",width:54,minValue:0,allowDecimals:true,allowNegative:false,name:"Height",emptyText:"H",maxLength:5,step:.25,repeatTriggerClick:false},{html:"&nbsp;",xtype:"box",border:false,style:"padding-top:8px; padding-right:0px;"}]},{fieldLabel:"Weight",xtype:"fieldcontainer",itemId:"weight",labelAlign:"top",msgTarget:"side",anchor:"100%",combineErrors:true,layout:{type:"hbox",pack:"start",align:"stretchmax"},items:[{width:50,allowNegative:false,allowDecimals:false,minValue:0,maxLength:3,name:"WeightLbs",xtype:"numberfield",repeatTriggerClick:false},{html:"&nbsp;lbs.&nbsp;&nbsp;",border:false,xtype:"box",style:"padding-top:8px; padding-right:0px;"},{xtype:"numberfield",width:50,itemId:"weightOz",msgTarget:"none",name:"WeightOz",minValue:0,allowNegative:false,allowDecimals:false,repeatTriggerClick:false},{html:"&nbsp;oz.",border:false,xtype:"box",style:"padding-top:8px; padding-right:0px;"},{margin:"0 0 0 10",xtype:"button",text:"Scale",icon:SS.url.app+"icons/weigh.png",sellerSetting:"UsbScale",scope:this,handler:function(a){SS.helper.GetScaleWeight(function(a,b){this.up("form").getForm().setValues({WeightLbs:a,WeightOz:b})},a)}}]},{xtype:"panel",border:false,layout:{type:"hbox",pack:"center"},hidden:true,bodyPadding:"4 0 0 0",itemId:"lnkpackages",sellerSetting:"MultiPackage",items:[{xtype:"button",itemId:"btnPackages",icon:SS.url.app+"icons/boxes16.png",text:" Ship Multiple Packages",scope:this,handler:function(){var a=new SS.orders.OrderPackages({record:this.record});a.on("saved",function(){this.record.setDirty();var a=this.record.OrderPackages();a.commitChanges();for(var d=0,c=0,b=0;b<a.getCount();b++){d+=a.getAt(b).get("Weight")||0;c+=a.getAt(b).get("DeclaredValue")||0}this.record.set("WeightOz",d%16);this.record.set("WeightLbs",d/16);this.record.set("InsuredValue",c);this.down("form").getForm().setValues({WeightOz:this.record.get("WeightOz"),WeightLbs:this.record.get("WeightLbs"),Height:null,Width:null,Length:null,InsuredValue:c});this.showMultiPackage()},this);a.show()}}]}]},{xtype:"checkbox",hideLabel:true,margin:"0 0 0 40",itemId:"chkDefault",inputValue:"true",uncheckedValue:"false",hidden:this.isCalculator,boxLabel:"<b>Save as Product Defaults</b>",name:"SaveDefault"},{xtype:"box",itemId:"upsTm",hidden:true,padding:4,dock:"bottom",style:"font-size:0.8em; text-align:left",html:"<br>UPS, the UPS Shield trademark, the UPS Ready mark, the UPS Developer Kit mark and the Color Brown are trademarks of United Parcel Service of America, Inc. All Rights Reserved."}]}]}]}]});this.callParent();amplify.subscribe("rates_updated",this,function(){if(this.record){var a=this.down("#rateQuote");a&&a.update(this.record.data)}},5)},applyPreset:function(f){var c=SS.data.OrderStores.PresetStore.findExact("PresetID",f);if(c>-1){var a=SS.data.OrderStores.PresetStore.getAt(c),b={};a.data.WarehouseID!=null&&Ext.apply(b,{WarehouseID:a.data.WarehouseID});a.data.ProviderID!=null&&Ext.apply(b,{ProviderID:a.data.ProviderID});a.data.ServiceID!=null&&Ext.apply(b,{ServiceID:a.data.ServiceID});a.data.PackageTypeID!=null&&Ext.apply(b,{RequestedPackageTypeID:a.data.PackageTypeID});a.data.InsuranceProviderID!=null&&Ext.apply(b,{InsuranceProvider:a.data.InsuranceProviderID});a.data.ConfirmationID!=null&&Ext.apply(b,{Confirmation:a.data.ConfirmationID});a.data.Height!=null&&Ext.apply(b,{Height:a.data.Height});a.data.Width!=null&&Ext.apply(b,{Width:a.data.Width});a.data.Length!=null&&Ext.apply(b,{Length:a.data.Length});if(a.data.WeightOz!=null){var d,e;d=a.data.WeightOz/16;e=a.data.WeightOz%16;Ext.apply(b,{WeightLbs:Math.floor(d),WeightOz:e})}this.down("#rateForm").getForm().setValues(b);_kmq.push(["record","[Orders] Applied Preset"])}},shipOrFill:function(){if(this.record.data.FillMethod==2||this.record.data.OrderStatusID==1&&!_settings.CanShip&&_settings.CanFulfill){this.down("#ship-or-fill").getLayout().setActiveItem(0);this.down("#fill-method-label").items.get(0).setBodyStyle("font-weight: normal; color:gray");this.down("#fill-method-label").items.get(1).setBodyStyle("text-align:right; font-weight:bold; color:black")}else{this.down("#ship-or-fill").getLayout().setActiveItem(1);this.down("#fill-method-label").items.get(0).setBodyStyle("font-weight:bold; color:black;");this.down("#fill-method-label").items.get(1).setBodyStyle("text-align:right; font-weight:normal; color:gray")}this.down("#btnCalc").setVisible(this.record.data.FillMethod!=2)},loadRecord:function(a){this.suspendEvents(false);this.record=a;if(this.record.data.ProviderID){var b=SS.data.OrderStores.ProviderStore.findExact("ProviderID",this.record.data.ProviderID);if(b>-1)this.record.data.CarrierID=SS.data.OrderStores.ProviderStore.getAt(b).get("CarrierID");this.down("#upsTm").setVisible(this.record.data.ProviderID==3)}this.down("#cpsCombos").updateChoices();this.down("#rateForm").getForm().loadRecord(a);this.down("#insuredValue").setDisabled(!a.data.InsuranceProvider);this.down("#reqService").update(a.data);this.down("#rateQuote").update(a.data);this.down("#chkDefault").setDisabled(a.data.ItemCount>1||!a.data.ProductID);this.showMultiPackage();this.shipOrFill();this.resumeEvents();if(this.presetMenu==null){this.presetMenu=new Ext.menu.Menu({renderTo:Ext.getBody(),showSeparator:false,items:[],listeners:{scope:this,click:function(c,a){if(a)if(a.itemId=="manage-presets"){var b=new SS.settings.Presets;b.on("close",function(){this.buildPresetMenu()},this);b.show()}else this.applyPreset(a.presetid)}}});this.buildPresetMenu()}}});SS.orders.Rates=Ext.extend(Ext.panel.Panel,{initComponent:function(){Ext.apply(this,{layout:{type:"card"},actionItem:0,title:"Shipping",items:[{border:false,bodyPadding:"100 12 12 12",bodyStyle:"text-align:center; color:gray",html:"No orders are selected.  Select one or more orders to make quick changes."},new SS.orders.Ship({itemId:"single",padding:"0 0 0 8"}),new SS.BatchShip({itemId:"batch"})]});this.callParent();this.down("#single").on("datachange",function(b){var a=this.down("#single").record;a.beginEdit();if(!b||b.name!="SaveDefault"){a.set("ShippingCost",null);a.set("OtherCost",null);a.set("InsuranceCost",null);a.set("ConfirmationCost",null);a.set("RateError",null);this.down("#single").down("#rateQuote").update(a.data)}this.down("#single").down("#rateForm").getForm().updateRecord(a);a.endEdit()},this);this.down("#batch").on("batchupdate",function(a){this.fireEvent("batchupdate",a)},this)},applyPreset:function(a){if(!this.records)return;if(this.records.length==1)this.items.get(1).applyPreset(a);else this.records.length>1&&this.down("#batch").applyPreset(a)},loadRecords:function(a){this.records=a;if(!a||a.length==0)this.getLayout().setActiveItem(0);else if(a.length==1){this.getLayout().setActiveItem(this.down("#single"));this.items.get(1).loadRecord(a[0])}else{this.getLayout().setActiveItem(this.down("#batch"));this.down("#batch").loadRecords(this.records)}}})