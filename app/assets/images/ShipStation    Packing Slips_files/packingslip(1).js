SS.settings.PackingSlipTemplate=Ext.extend(Ext.window.Window,{setSelectedText:function(c){var d=this.getCurrentEditor(),e=d.items.get(0).getInputId(),a=document.getElementById(e);if(a.createTextRange){var b=a.createTextRange();b.move("character",this.caretPos);b.select();b.text=c}else if(!isNaN(a.selectionStart)){a.focus();a.setSelectionRange(this.caretPos,this.caretPos);a.value=a.value.substring(0,a.selectionStart)+c+a.value.substring(a.selectionStart,a.selectionEnd)+a.value.substring(a.selectionEnd,a.value.length);a.setSelectionRange(this.caretPos,this.carePos+c.length)}},insertField:function(a){this.saveCaretPos();var b=a.content||a.text;this.setSelectedText(b)},getCurrentEditor:function(){for(var b=this.down("#templates"),a=0;a<b.items.length;a++)if(!b.items.get(a).collapsed)return b.items.get(a)},saveCaretPos:function(){var d=this.getCurrentEditor(),e=d.items.get(0).getInputId(),b=document.getElementById(e),a,c=-1;if(typeof b.selectionStart=="number")c=b.selectionStart;else if(document.selection&&b.createTextRange){a=document.selection.createRange();a.collapse(true);a.moveStart("character",-b.value.length);c=a.text.length}this.caretPos=c},setSelectedText:function(c){var d=this.getCurrentEditor(),e=d.items.get(0).getInputId(),a=document.getElementById(e);if(a.createTextRange){var b=a.createTextRange();b.move("character",this.caretPos);b.select();b.text=c}else if(!isNaN(a.selectionStart)){a.focus();a.setSelectionRange(this.caretPos,this.caretPos);a.value=a.value.substring(0,a.selectionStart)+c+a.value.substring(a.selectionStart,a.selectionEnd)+a.value.substring(a.selectionEnd,a.value.length)}},initComponent:function(){var a=[];SS.data.OrderStores.StoreStore.each(function(b){a.push({text:b.get("StoreName"),storeId:b.get("StoreID"),icon:SS.url.app+"icons/marketplace/"+b.get("Marketplace").Name+".png"})});Ext.applyIf(this,{autoHeight:true,autoWidth:true,layout:"fit",modal:true,items:[{border:false,xtype:"form",itemId:"tplForm",width:800,standardSubmit:true,url:SS.url.app+"Settings/PrintSamplePackingSlip",bodyPadding:8,layout:"anchor",defaults:{labelAlign:"top"},items:[{xtype:"hiddenfield",name:"Size"},{fieldLabel:"<b>Template Name</b>",labelAlign:"left",name:"Name",allowBlank:false,anchor:"100%",xtype:"textfield",maxLength:50,border:true,enforceMaxLength:true},{height:500,layout:{type:"hbox",align:"stretch"},items:[{flex:1,layout:{type:"accordion"},itemId:"templates",defaults:{headerStyle:"font-weight:bold",iconCls:"template-icon"},border:false,items:[{title:"<b>Order Header</b>",layout:"fit",items:[{itemId:"header",name:"Header",xtype:"textarea"}]},{title:"<b>Order Items Header</b>",layout:"fit",items:[{itemId:"items-header",name:"ItemsHeader",xtype:"textarea"}]},{title:"<b>Order Items</b>",itemId:"itemsTemplate",layout:"fit",items:[{itemId:"items",name:"Items",xtype:"textarea"}]},{title:"<b>Order Footer</b>",layout:"fit",items:[{itemId:"footer",name:"Footer",xtype:"textarea"}]}]},{width:200,margins:"0 0 0 0",layout:{type:"accordion"},bodyStyle:"background-color:gray",title:"Field Replacements",defaults:{border:false,autoHeight:true,layout:"anchor",bodyStyle:"background-color:gray",autoScroll:true},items:[{title:"<b>Store</b>",layout:{type:"vbox",align:"stretch"},defaults:{anchor:"100%",margin:"4 4 0 4",xtype:"button",scope:this,handler:this.insertField},items:[{text:"[Store Company Name]"},{text:"[Store Phone]"},{text:"[Store Email]"},{text:"[Store Logo]",content:'<img src="http://src.sencha.io/300/60/http://images.shipstation.com/[Store Logo]" />'},{text:"[Store Website]",content:"[Store Website]"},{text:"[Packing Slip Message]"}]},{title:"<b>Recipient</b>",defaults:{margin:"4 4 0 4",xtype:"button",scope:this,handler:this.insertField},layout:{type:"vbox",align:"stretch"},items:[{text:"[Recipient Company]"},{text:"[Recipient Name]"},{text:"[Recipient Email]"},{text:"[Recipient Address]"},{text:"[Recipient Phone]"}]},{title:"<b>Order / Shipment</b>",defaults:{margin:"4 4 0 4",xtype:"button",scope:this,handler:this.insertField},layout:{type:"vbox",align:"stretch"},items:[{text:"[Order #]"},{text:"[Scan Order #]"},{text:"[Buyer Name]"},{text:"[Username]"},{text:"[Ship Date]"},{text:"[Order Date]"},{text:"[Current Date]"},{text:"[Total Quantity]"},{text:"[Payment Date]"},{text:"[Carrier Name]"},{text:"[Package Type]"},{text:"[Shipping Service]"},{text:"[Requested Shipping Service]"},{text:"[Notes to Buyer]"},{text:"[Notes from Buyer]"},{text:"[Internal Notes]"},{text:"[Gift Message]"},{text:"[Tax Paid]"},{text:"[Dimensions]"},{text:"[Weight]"},{text:"[Custom Field #1]"},{text:"[Custom Field #2]"},{text:"[Custom Field #3]"}]},{title:"<b>Warehouse</b>",defaults:{margins:"4 4 0 4",xtype:"button",scope:this,handler:this.insertField},layout:{type:"vbox",align:"stretch"},items:[{text:"[Warehouse Address]"},{text:"[Warehouse Name]"},{text:"[Warehouse Company]"},{text:"[Warehouse Country]"}]},{title:"<b>Order Items</b>",itemId:"itemFields",disabled:true,defaults:{margin:"4 4 0 4",xtype:"button",scope:this,handler:this.insertField},layout:{type:"vbox",align:"stretch"},items:[{text:"[Sku]"},{text:"[Item Title]"},{text:"[Unit Price]"},{text:"[Quantity]"},{text:"[Extended Price]"},{text:"[Image Url]"},{text:"[Product Name]"},{text:"[Warehouse Location]"},{text:"[Marketplace Item #]"},{text:"[Item Options]"},{text:"[Fill Sku]"}]}]}]}]}],buttonAlign:"left",buttons:[{scope:this,text:"Cancel",scale:"medium",handler:function(){this.close()}},"->",{text:"<b>Download Sample</b>",scale:"medium",icon:SS.url.app+"icons/invoice24.png",scope:this,menu:{items:a,listeners:{scope:this,click:function(b,a){this.down("#tplForm").getForm().updateRecord(this.record);Ext.Ajax.request({url:SS.url.app+"Settings/ValidatePackingSlip",method:"POST",scope:this,jsonData:{template:this.record.data},callback:function(f,e,c){var b=Ext.decode(c.responseText);if(b.success)this.down("#tplForm").getForm().submit({method:"post",params:{storeId:a.storeId}});else{this.setLoading(false);var d=new Ext.window.Window({modal:true,height:400,width:400,layout:"fit",items:[{data:b.errors,tpl:['<div style="padding:6px; border-bottom:solid 2px gray;">Your packing slip template could not be saved due to HTML validation errors.  Please correct the following issues and try to save your template again.</div>','<tpl for=".">','<div class="validation-error">{.}</div>',"</tpl>"]}],buttonAlign:"center",buttons:[{scope:this,text:"Close",handler:function(a){a.up("window").close()}}]});d.show()}}})}}},handler:function(){return;if(!this.down("form").getForm().isValid())return;this.down("#tplForm").getForm().submit({method:"post"})}},"->",{text:"<b>Save Changes</b>",icon:SS.url.app+"icons/save24.png",scale:"medium",scope:this,handler:function(){if(!this.down("form").getForm().isValid())return;this.setLoading("Saving changes...");this.down("#tplForm").getForm().updateRecord(this.record);Ext.Ajax.request({url:SS.url.app+"Settings/ValidatePackingSlip",method:"POST",scope:this,jsonData:{template:this.record.data},callback:function(e,d,b){var a=Ext.decode(b.responseText);if(a.success)this.record.save({scope:this,success:function(){this.setLoading(false);this.fireEvent("recordsaved");this.close()},failure:function(){this.setLoading(false);Ext.Msg.alert("An error occurred","An error occurred while saving changes.")}});else{this.setLoading(false);var c=new Ext.window.Window({modal:true,height:400,width:400,layout:"fit",items:[{data:a.errors,tpl:['<div style="padding:6px; border-bottom:solid 2px gray;">Your packing slip template could not be saved due to HTML validation errors.  Please correct the following issues and try to save your template again.</div>','<tpl for=".">','<div class="validation-error">{.}</div>',"</tpl>"]}],buttonAlign:"center",buttons:[{scope:this,text:"Close",handler:function(a){a.up("window").close()}}]});c.show()}}})}}]});this.callParent();this.setTitle(this.record.data.Name);this.down("#tplForm").getForm().loadRecord(this.record);this.down("#itemsTemplate").on("expand",function(){this.down("#itemFields").setDisabled(false);this.down("#itemFields").expand()},this);this.down("#itemsTemplate").on("collapse",function(){this.down("#itemFields").collapse();this.down("#itemFields").setDisabled(true)},this)}})