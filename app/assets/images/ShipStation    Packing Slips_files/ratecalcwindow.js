SS.RateCalculator=Ext.extend(Ext.Window,{selectService:function(d,c,a,e,b,f){this.down("#shipment").applyChanges();this.record.set("ProviderID",c);this.record.set("ServiceID",d);this.record.set("ShippingCost",e);this.record.set("ConfirmationCost",b);this.record.set("OtherCost",f);this.record.set("RateError",null);a&&this.record.set("RequestedPackageTypeID",a);this.fireEvent("recordupdated",this.record);this.close()},getRates:function(){var g=this.down("#destForm").getForm(),b=true;if(!this.down("#dummyCountry").isHidden())b=g.isValid();b=this.down("#shipment").down("form").getForm().isValid()&&b;var a=this.down("#shipment").getValues();if(!a.ProviderID){b=false;this.down("#cboCarrier").markInvalid("Carrier must be specified")}if(a&&a.WeightOz&&a.WeightLbs){if(parseInt(a.WeightOz)<1&&parseInt(a.WeightLbs)<1){b=false;this.down("#weightOz").markInvalid("Weight must be specified")}}else if(this.record&&this.record.OrderPackages())if(this.record.get("WeightLbs")<1&&this.record.get("WeightOz")<1){b=false;this.down("#weightOz").markInvalid("Weight must be specified")}if(!b)return;this.down("#weightOz").clearInvalid();Ext.apply(a,this.down("#destForm").getForm().getValues());var f=[],d=[];if(this.record){for(var c=0;c<this.record.OrderPackages().getCount();c++)f.push(this.record.OrderPackages().getAt(c).data);for(var c=0;c<this.record.CustomsItems().getCount();c++)d.push(this.record.CustomsItems().getAt(c).data);a.ShipState=this.record.get("ShipState")}var e=null;if(this.record&&this.record.data)e=this.record.data.ShipCity;this.down("#rates").getLoader().load({params:{allowSelection:!this.isDummyOrder,carrierId:a.CarrierID,providerId:a.ProviderID,country:a.ShipCountryCode,postalCode:a.ShipPostalCode,warehouseId:a.WarehouseID,insuredValue:a.InsuranceProvider?a.InsuredValue:0,confirmation:a.Confirmation||0,lbs:a.WeightLbs||0,oz:a.WeightOz||0,"package":a.RequestedPackageTypeID,l:a.Length,w:a.Width,h:a.Height,city:e,residential:a.ResidentialIndicator=="R",nonMachinable:false,saturdayDelivery:false,alcohol:false,ShipState:a.ShipState},jsonData:{packages:f,customsItems:d}})},initComponent:function(){Ext.applyIf(this,{width:800,height:500,modal:true,title:"Shipping Rate Calculator",layout:{type:"hbox",pack:"start",align:"stretch"},defaults:{border:false},items:[{layout:{type:"vbox",align:"stretch"},width:280,items:[{html:"<b>Please Note:</b> Calculated shipping rates do not include applicable insurance",border:false,bodyStyle:"text-align:center",bodyPadding:8},{xtype:"form",itemId:"destForm",padding:"8 8 0 8",border:false,fieldDefaults:{labelWidth:80,labelAlign:"left",anchor:"100%",validateOnBlur:false,validateOnChange:false},items:[{fieldLabel:"<b>To Country</b>",xtype:"country_combo",itemId:"dummyCountry",name:"ShipCountryCode",allowBlank:false},{fieldLabel:"<b>To Zipcode</b>",itemId:"dummyZip",xtype:"textfield",anchor:"70%",maxLength:10,enforceMaxLength:true,name:"ShipPostalCode",validator:function(b){var a=this.up("form").getForm().getValues().ShipCountryCode;return a=="US"&&!this.isHidden()?!/\d{5}-?\d{0,4}/.test(b)?"The zipcode is invalid":true:true}},{xtype:"checkbox",name:"ResidentialIndicator",itemId:"dummyResidential",inputValue:"C",uncheckedValue:"R",value:"R",fieldLabel:"&nbsp;",labelSeparator:"",boxLabel:"Commercial Address",margin:"0 0 8 0"}]},new SS.orders.Ship({padding:"0 8 0 8",flex:1,isCalculator:true,showSelectedService:false,itemId:"shipment"}),{layout:{type:"hbox",align:"top",pack:"center"},height:64,padding:"0 0 0 0",border:false,items:[{xtype:"button",scale:"medium",margins:"auto",text:"<b>Display Shipping Rates</b>",disabled:false,icon:SS.url.app+"icons/calculator.png",scope:this,handler:function(){this.getRates()}}]}]},{itemId:"rates",flex:1,autoScroll:true,style:"border-left:solid 1px silver",title:"Shipping Fees",loader:{url:SS.url.app+"orders/rates",ajaxOptions:{method:"POST"},loadMask:{msg:"Getting Rates..."}}}]});this.callParent();this.down("#shipment").ratesEl=this.down("#rates");this.down("#rates").on("afterrender",function(){this.down("#rates").body.on("click",function(h,a){if(a){var c=parseInt(a.getAttribute("serviceId"),10),g=parseInt(a.getAttribute("packageId"),10),b=parseInt(a.getAttribute("providerId"),10),e=parseFloat(a.getAttribute("shipping")),d=parseFloat(a.getAttribute("confirmation")),f=parseFloat(a.getAttribute("other"));c&&b&&this.selectService(c,b,g,e,d,f)}},this)},this);if(this.record){this.setTitle("Shipping Rate Calculator: Order #"+this.record.data.OrderNumber);this.isDummyOrder=false;this.down("#dummyCountry").setVisible(false);this.down("#dummyZip").setVisible(false);this.down("#dummyResidential").setVisible(false);this.down("#shipment").loadRecord(this.record);this.down("#destForm").getForm().loadRecord(this.record);this.on("show",function(){this.getRates()},this)}else{this.isDummyOrder=true;var b=SS.data.OrderStores.WarehouseStore.findExact("Default",true),a=undefined;if(b>-1)a=SS.data.OrderStores.WarehouseStore.getAt(b).get("WarehouseID");var c=Ext.ModelManager.create({ShipCountryCode:"US",CarrierID:1,WarehouseID:a,WeightOz:1,ResidentialIndicator:"C"},"Order");this.down("#shipment").loadRecord(c);this.down("#destForm").getForm().loadRecord(c)}}})